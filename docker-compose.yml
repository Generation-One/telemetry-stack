services:
  # Pomerium reverse proxy with Google OAuth
  # Access admin panels via:
  #   https://grafana.localhost
  #   https://jaeger.localhost
  #   https://seq.localhost

  pomerium:
    container_name: pomerium
    image: pomerium/pomerium:latest
    depends_on:
      - pomerium-config
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - pomerium_config:/pomerium
    environment:
      - JWT_CLAIMS_HEADERS=email
      - IDP_PROVIDER=${POMERIUM_IDP_PROVIDER}
      - IDP_CLIENT_ID=${POMERIUM_IDP_CLIENT_ID}
      - IDP_CLIENT_SECRET=${POMERIUM_IDP_CLIENT_SECRET}
      - COOKIE_SECRET=${POMERIUM_COOKIE_SECRET}
      - SIGNING_KEY=${POMERIUM_SIGNING_KEY}
      - POMERIUM_AUTHENTICATE_DOMAIN=${POMERIUM_AUTHENTICATE_DOMAIN:-authenticate.localhost}
      - GRAFANA_DOMAIN=${GRAFANA_DOMAIN:-grafana.localhost}
      - JAEGER_DOMAIN=${JAEGER_DOMAIN:-jaeger.localhost}
      - SEQ_DOMAIN=${SEQ_DOMAIN:-seq.localhost}
    restart: unless-stopped

  # rewrite config template with env
  pomerium-config:
    image: alpine
    env_file: .env
    volumes:
      - ./pomerium.template.yaml:/config-template/pomerium.template.yaml
      - pomerium_config:/config
    command: >
      sh -c "
        apk add --no-cache gettext &&
        envsubst < /config-template/pomerium.template.yaml > /config/config.yaml
      "

  # Protected by Pomerium - access via https://jaeger.localhost
  jaeger-all-in-one:
    container_name: jaeger
    image: jaegertracing/all-in-one
    environment:
      - COLLECTOR_OTLP_ENABLED=true
      - QUERY_BASE_PATH=${JAEGER_BASE_PATH:-/}
    volumes:
      - jaeger_data:/badger
    restart: unless-stopped

  # http://localhost:9090/
  prometheus:
    container_name: prometheus
    image: prom/prometheus
    volumes:
      - ./prometheus.yml:/etc/prometheus/prometheus.yml
      - prometheus_configs:/etc/prometheus
      - prometheus_data:/prometheus
    restart: unless-stopped

  # Protected by Pomerium - access via https://grafana.localhost
  grafana:
    container_name: grafana
    image: grafana/grafana-oss
    volumes:
      - grafana_storage:/var/lib/grafana
      - ./grafana/provisioning:/etc/grafana/provisioning
    environment:
      - GF_SERVER_ROOT_URL=https://${GRAFANA_DOMAIN:-grafana.localhost}
      - GF_SERVER_DOMAIN=${GRAFANA_DOMAIN:-grafana.localhost}
      - GF_SERVER_SERVE_FROM_SUB_PATH=false
      # Auth handled by Pomerium - use proxy auth with identity headers
      - GF_USERS_ALLOW_SIGN_UP=false
      - GF_USERS_AUTO_ASSIGN_ORG=true
      - GF_USERS_AUTO_ASSIGN_ORG_ROLE=Admin
      - GF_AUTH_PROXY_ENABLED=true
      - GF_AUTH_PROXY_HEADER_NAME=X-Pomerium-Claim-Email
      - GF_AUTH_PROXY_HEADER_PROPERTY=email
      - GF_AUTH_PROXY_AUTO_SIGN_UP=true
      - GF_AUTH_DISABLE_LOGIN_FORM=true
      - GF_AUTH_PROXY_ENABLE_LOGIN_TOKEN=false
      - GF_AUTH_DISABLE_SIGNOUT_MENU=true
    restart: unless-stopped
    
  seq:
    image: datalust/seq:latest
    container_name: seq
    environment:
      - ACCEPT_EULA=Y
      - SEQ_REVERSEPROXY_AUTHENTICATION=true
      - SEQ_REVERSEPROXY_USERHEADER=X-Pomerium-Jwt-Email
      - SEQ_REVERSEPROXY_NAMEHEADER=X-Pomerium-Jwt-Name
      - SEQ_REVERSEPROXY_TRUSTEDPROXIES=0.0.0.0/0
    volumes:
      - seq_data:/data
    restart: unless-stopped

  # OpenTelemetry Collector
  otel-collector:
    image: otel/opentelemetry-collector-contrib
    command: ["--config=/etc/otel-collector-config.yaml"]
    privileged: true
    environment:
      - OTEL_LOG_LEVEL=debug
      - LOG_LEVEL=debug
    volumes:
      - ./otel-collector-config.yaml:/etc/otel-collector-config.yaml
    ports:
      - "55679:55679" # zPages
      - "4317:4317"   # OTLP gRPC receiver
      - "4318:4318"   # OTLP http receiver
    restart: unless-stopped
      
volumes:
  pomerium_config:
  grafana_storage:
  prometheus_configs:
  prometheus_data:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ${PROMETHEUS_DATA_PATH:-./data/prometheus}
  jaeger_data:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ${JAEGER_DATA_PATH:-./data/jaeger}
  seq_data:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ${SEQ_DATA_PATH:-./data/seq}
